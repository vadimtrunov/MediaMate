---
name: investigate
description: Technical problem investigation. Use when diagnosing bugs, performance issues, or unexpected behavior through hypothesis-driven analysis.
allowed-tools: Read, Write, Edit, Glob, Grep, Bash, Task, AskUserQuestion
argument-hint: "[problem description]"
---

# Investigation

Ты — инженер который расследует технические проблемы итеративно. Формулируешь гипотезы, проверяешь их, учишься на ошибках, накапливаешь опыт.

---

## Твой флоу

```
ФАЗА 1: GATHER      → Опрос о проблеме, сбор симптомов (код, логи, метрики)
ФАЗА 2: HYPOTHESIZE → Формулировка 2-3 гипотез о root cause
ФАЗА 3: VERIFY      → Итеративная проверка гипотез (через Task subagent)
ФАЗА 4: FIX         → Предложить решение, применить если подтверждено
ФАЗА 5: LEARN       → Консолидация опыта в INVESTIGATE.md (knowledge base)
```

---

## ФАЗА 1: GATHER

### 1.1 Загрузи контекст

```
Прочитай .claude/feedback/INVESTIGATE.md — там накопленный опыт расследований.
Учитывай паттерны "симптом → причина" при формулировке гипотез.
```

### 1.2 Проведи опрос

**ОБЯЗАТЕЛЬНО** задай эти вопросы оператору (используй AskUserQuestion):

#### Базовые вопросы:

1. **Что происходит?** — Опиши проблему в 1-2 предложениях
2. **Когда началось?** — Время начала, после какого события?
3. **Где проявляется?** — Какие сервисы/модули затронуты?
4. **Воспроизводимо?** — Всегда / иногда / один раз?
5. **Есть ли логи/ошибки?** — Текст ошибки, stack trace?

### 1.3 Собери симптомы

После опроса **ПАРАЛЛЕЛЬНО** собери данные:

#### Поиск в коде:
```bash
# Найди упоминания ошибки
Grep для поиска по тексту ошибки

# Найди связанные файлы
Glob для поиска файлов по паттерну
```

### 1.4 Создай INVESTIGATION.md

После сбора данных создай файл `INVESTIGATION.md` в корне проекта:

```markdown
# Investigation: [краткое описание проблемы]

## Problem Statement
[Что происходит — из опроса]

## Timeline
- **Начало:** [когда началось]
- **Событие-триггер:** [после чего началось]
- **Частота:** [всегда/иногда/один раз]

## Affected Components
- [сервис/модуль 1]
- [сервис/модуль 2]

## Symptoms Collected

### Error Messages
```
[текст ошибки/stack trace]
```

### Relevant Code
- `path/to/file.go:123` — [что найдено]

### Logs
[Выдержки из логов если есть]

### Metrics
[Аномалии в метриках если есть]

## Hypotheses
<!-- Заполняется в ФАЗЕ 2 -->

## Verification Log
<!-- Заполняется в ФАЗЕ 3 -->

## Root Cause
<!-- Заполняется после подтверждения гипотезы -->

## Fix Applied
<!-- Заполняется в ФАЗЕ 4 -->

---
*Создано: [дата]*
*Статус: gathering*
```

---

## ФАЗА 2: HYPOTHESIZE

### 2.1 Сформулируй гипотезы

На основе симптомов сформулируй **2-3 гипотезы** о root cause:

```markdown
## Hypotheses

### H1: [название гипотезы]
- **Описание:** [что могло сломаться]
- **Confidence:** HIGH/MEDIUM/LOW
- **Основание:** [почему так думаем]
- **Как проверить:** [конкретные шаги]

### H2: [название гипотезы]
- **Описание:** [что могло сломаться]
- **Confidence:** HIGH/MEDIUM/LOW
- **Основание:** [почему так думаем]
- **Как проверить:** [конкретные шаги]

### H3: [название гипотезы]
- **Описание:** [что могло сломаться]
- **Confidence:** HIGH/MEDIUM/LOW
- **Основание:** [почему так думаем]
- **Как проверить:** [конкретные шаги]
```

### 2.2 Согласуй порядок проверки

```
---
**Гипотезы сформулированы**

1. **H1** [HIGH]: [описание]
2. **H2** [MEDIUM]: [описание]
3. **H3** [LOW]: [описание]

---

Порядок проверки: H1 → H2 → H3 (по confidence)

Согласен с порядком? Или проверяем другую первой?
```

---

## ФАЗА 3: VERIFY (через Task subagent)

### 3.1 Цикл проверки гипотез

**КРИТИЧЕСКИ ВАЖНО:** Каждая гипотеза проверяется в ОТДЕЛЬНОМ контексте через Task tool.

```
for каждая гипотеза по порядку:

    1. ПОКАЖИ гипотезу оператору:
       - Название и описание
       - Что будем проверять
       - Ожидаемый результат

    2. ЗАПУСТИ Task subagent для проверки:
       - subagent_type: "general-purpose"
       - prompt: контекст гипотезы + инструкции

    3. ПОКАЖИ результат проверки

    4. СПРОСИ оператора:
       - "Гипотеза подтвердилась?"
       - "Нужно проверить глубже?"
       - "Переходим к следующей?"

    5. ОБНОВИ INVESTIGATION.md:
       - Запиши результат в Verification Log
       - Если подтвердилась → запиши Root Cause → ФАЗА 4
       - Если нет → следующая гипотеза
```

### 3.2 Шаблон промпта для Task subagent

```
Ты проверяешь ОДНУ гипотезу о причине проблемы. Контекст:

INVESTIGATION.md: [содержимое]
Knowledge base: .claude/feedback/INVESTIGATE.md

Гипотеза для проверки:
[H1/H2/H3: описание]

Как проверить:
[шаги проверки]

ПРАВИЛА:
1. Выполни ТОЛЬКО проверку этой гипотезы
2. Используй: Grep, Glob, Read для поиска в коде
3. НЕ делай фиксов — только диагностика
4. Верни отчёт:
   - Что проверил
   - Что нашёл (доказательства)
   - Вывод: ПОДТВЕРЖДЕНА / ОПРОВЕРГНУТА / НЕОПРЕДЕЛЁННО

НЕ обновляй INVESTIGATION.md — это сделает оркестратор.
```

### 3.3 Формат показа результата

```
---
**Проверка H1: [название]**

Что проверено:
- [шаг 1]
- [шаг 2]

Найдено:
- [находка 1]
- [находка 2]

Вывод: **ПОДТВЕРЖДЕНА** / **ОПРОВЕРГНУТА** / **НЕОПРЕДЕЛЁННО**

---

Варианты:
1. **Подтверждаю** — переходим к фиксу
2. **Проверить глубже** — уточнить проверку
3. **Следующая гипотеза** — H1 не причина
4. **Новая гипотеза** — добавить H4
```

### 3.4 Обновление Verification Log

```markdown
## Verification Log

### H1: [название] (YYYY-MM-DD)
- Результат: ОПРОВЕРГНУТА
- Проверено: [что делали]
- Находки: [что нашли]
- Вывод: Не является причиной потому что...

### H2: [название] (YYYY-MM-DD)
- Результат: ПОДТВЕРЖДЕНА
- Проверено: [что делали]
- Находки: [что нашли]
- Вывод: Root cause найден: [описание]
```

---

## ФАЗА 4: FIX (через Task subagent)

### 4.1 Предложи решение

Когда гипотеза подтверждена:

```
---
**Root Cause найден: [описание]**

Предлагаемое решение:
[описание фикса]

Затронутые файлы:
- `path/to/file.go`

Риски:
- [риск 1 если есть]

---

Применить фикс?
1. **Да** — исправить
2. **Изменить подход** — другое решение
3. **Только документировать** — не фиксить сейчас
```

### 4.2 Применение фикса

Если оператор согласен, примени фикс (напрямую или через subagent).

### 4.3 ОБЯЗАТЕЛЬНАЯ проверка после изменения кода

**КРИТИЧЕСКИ ВАЖНО:** После ЛЮБОГО изменения кода (Edit/Write) ОБЯЗАТЕЛЬНО выполни:

```bash
# 1. Build
go build ./...

# 2. Lint
golangci-lint run ./...

# 3. Tests
go test ./...
```

**НЕ ЗАВЕРШАЙ расследование пока все проверки не пройдут!**

Если проверки падают:
1. Исправь ошибки
2. Повтори проверки
3. Только потом переходи к 4.4

### 4.4 Показ результата фикса

```
---
**Фикс применён**

Изменения:
- `path/to/file.go` — [что изменилось]

Проверки:
- Build: OK/FAIL
- Lint: OK/FAIL
- Tests: OK/FAIL

---

Фикс работает?
1. **OK** — переходим к финализации
2. **Откатить** — git checkout
3. **Правки** — доработать
```

---

## ФАЗА 5: LEARN (финализация)

**ОБЯЗАТЕЛЬНО выполни после фикса — НЕ ПРОПУСКАЙ!**

### 5.1 Обнови knowledge base

1. Прочитай `.claude/feedback/INVESTIGATE.md`
2. Добавь новый урок в секцию `## Recent Lessons`
3. **Если файл > 100 строк** — сделай консолидацию:
   - Извлеки паттерны из Recent Lessons
   - Добавь их в `## Patterns` (компактная таблица)
   - Очисти Recent Lessons, оставив только последние 3

Формат урока:
```markdown
### [YYYY-MM-DD]: [Название]
- **Симптом:** [что видел пользователь]
- **Причина:** [root cause]
- **Решение:** [что сделали]
```

Формат паттерна (выжимка):
```markdown
| [Симптом кратко] | [Причина кратко] | [Решение кратко] |
```

### 5.2 Удали INVESTIGATION.md

```bash
rm INVESTIGATION.md
```

### 5.3 Покажи итог

```
---
**Investigation завершён!**

Проблема: [краткое описание]
Root Cause: [причина]
Фикс: [что сделали]

Урок добавлен в knowledge base.
---
```

---

## Команды оператора

| Команда | Действие |
|---------|----------|
| `skip` | Пропустить текущую гипотезу |
| `pause` | Остановить, сохранить прогресс |
| `add hypothesis` | Добавить новую гипотезу |
| `status` | Показать статус расследования |
| `abort` | Отменить расследование |
| `fix only` | Пропустить verify, сразу к фиксу |

---

## Обработка ситуаций

### Все гипотезы опровергнуты
```
Спроси оператора:
1. Добавить новые гипотезы?
2. Собрать больше симптомов?
3. Привлечь эксперта (escalate)?
```

### Проблема не воспроизводится
```
Документируй симптомы для будущего.
Добавь в INVESTIGATE.md как "intermittent issue".
Предложи добавить мониторинг/алерты.
```

### Фикс требует больших изменений
```
НЕ фикси автоматически.
Предложи создать отдельную задачу/тикет.
Документируй workaround если есть.
```

### Несколько root causes
```
Документируй все найденные причины.
Приоритизируй по impact.
Фикси по одной с подтверждением.
```

---

## Старт

$ARGUMENTS

**Начни с ФАЗЫ 1: GATHER**

1. Прочитай `.claude/feedback/INVESTIGATE.md` (создай если нет)
2. Задай вопросы оператору о проблеме
3. Собери симптомы (код, логи, метрики)
4. Создай INVESTIGATION.md
5. Покажи summary и переходи к ФАЗЕ 2
