---
name: next
description: Find the next task from ROADMAP.md, critically evaluate it, ask clarifying questions, and launch /feature for implementation.
allowed-tools: Read, Write, Edit, Glob, Grep, Bash, Task, AskUserQuestion, Skill
disable-model-invocation: true
---

# Next Roadmap Task

Ты — архитектор-аналитик. Твоя задача: найти следующую задачу из родмапа, критически её оценить, задать вопросы и запустить `/feature`.

---

## Твой флоу

```
ФАЗА 1: PARSE    → Найти следующую задачу из ROADMAP.md
ФАЗА 2: EVALUATE → Критический анализ задачи + исследование кодбейса
ФАЗА 3: CLARIFY  → Задать вопросы оператору
ФАЗА 4: LAUNCH   → Запустить /feature с подготовленным промптом
```

---

## ФАЗА 1: PARSE (найти следующую задачу)

### 1.1 Прочитай родмап

```
Прочитай docs/ROADMAP.md
```

### 1.2 Определи завершённые фазы

Завершённые sub-phases отмечены `✅` в заголовке:
```
### 1.1 Configuration System ✅    ← завершена
### 1.2 Structured Logging ✅      ← завершена
### 1.3 LLM Integration            ← НЕ завершена (нет ✅)
```

Сканируй заголовки уровня `###` (sub-phases). Ищи первый заголовок БЕЗ `✅`.

**Важно:** Задачи внутри фазы тоже могут иметь ✅ (в таблице), но определяющий маркер — именно `✅` в заголовке `###`.

### 1.3 Извлеки информацию о задаче

Из найденной секции собери:
- **Номер и название** фазы (например "1.1 LLM Integration")
- **Родительская фаза** и её цель (например "Phase 1: MVP Backend")
- **Список задач** — все строки с чекбоксами
- **Код-сниппеты** — примеры API/структур из родмапа
- **Зависимости** — что должно быть сделано до этой фазы

### 1.4 Проверь зависимости

Для каждой зависимости:
1. Найди соответствующий заголовок в родмапе
2. Проверь есть ли `✅`
3. Если зависимость НЕ завершена — это блокер, сообщи оператору

### 1.5 Покажи результат

```
Следующая задача из родмапа:

Phase X.Y: [название]
Родительская фаза: Phase X — [цель]
Зависимости: [список] (все OK / есть блокеры)
Задач: N

Задачи:
1. описание
2. описание
...
```

---

## ФАЗА 2: EVALUATE (критический анализ)

### 2.1 Загрузи контекст

Прочитай параллельно (через несколько Read вызовов):
1. `.claude/feedback/PROJECT.md` — накопленный опыт
2. Релевантные docs — определи по содержимому задачи:
   - Спецификация → `docs/SPEC.md`
   - Другие документы в `docs/`

### 2.2 Исследуй кодбейс

Используй Task tool с subagent_type=Explore:

```
Исследуй кодбейс MediaMate и ответь:
1. Какие пакеты уже существуют в internal/?
2. Есть ли заготовки для [целевого пакета]?
3. Какие паттерны используются в существующем коде?
   - Как инициализируются компоненты?
   - Как используется конфиг?
   - Как используется логгер?
4. Есть ли в go.mod зависимости релевантные для этой задачи?
5. Какие интерфейсы уже определены?
```

### 2.3 Критический анализ

Оцени план из родмапа по каждому пункту:

#### Acceptance Criteria
- Достаточно ли конкретные? Можно ли автоматически проверить?
- Нет ли пропущенных критериев?

#### API Design (код-сниппеты из родмапа)
- Совместим ли предложенный API с существующими паттернами?
- Правильные ли типы параметров?
- Нужны ли дополнительные методы?
- Соответствует ли design doc?

#### Зависимости
- Все ли зависимости действительно выполнены?
- Есть ли скрытые зависимости не указанные в родмапе?

#### Scope
- Реалистичен ли объём для одной `/feature` сессии?
- Стоит ли разбить на несколько `/feature` запусков?

#### Конфликты
- Нет ли конфликтов с DO/DON'T из PROJECT.md?
- Нет ли устаревшей информации в родмапе?

### 2.4 Сформируй выводы

Составь список:
- **Готово к реализации** — что можно брать как есть
- **Требует уточнения** — что неясно или неполно
- **Предлагаю изменить** — что стоит сделать иначе чем в родмапе
- **Риски** — потенциальные проблемы

---

## ФАЗА 3: CLARIFY (вопросы оператору)

### 3.1 Покажи анализ

```
Анализ задачи Phase X.Y: [название]

Готово к реализации:
- [пункт 1]
- [пункт 2]

Требует уточнения:
- [вопрос 1]
- [вопрос 2]

Предлагаю изменить:
- [предложение 1]
- [предложение 2]

Риски:
- [риск 1]
```

### 3.2 Задай вопросы

Используй AskUserQuestion. Типичные вопросы:

1. **Scope:** "Делаем все N задач за один проход, или частями?"
2. **Design:** "[конкретный вопрос по API/архитектуре на основе анализа]"
3. **Deviations:** "В родмапе предложено X, но в коде уже паттерн Y. Используем Y?"
4. **Priority:** "Начинаем с [задача A] или [задача B]?"

**Правила:**
- Задавай ТОЛЬКО вопросы, ответы на которые реально влияют на реализацию
- Не спрашивай очевидное
- Если ответ можно вывести из контекста — выведи и подтверди
- Максимум 4 вопроса (лимит AskUserQuestion)

---

## ФАЗА 4: LAUNCH (запуск /feature)

### 4.1 Составь промпт для /feature

На основе задач роадмапа, результатов анализа, ответов оператора и паттернов из кодбейса.

Сформируй детальное описание задачи:

```
Phase X.Y: [название]

Что делаем:
[описание на основе родмапа + уточнений оператора]

Acceptance Criteria:
- [критерий 1 — из родмапа или уточнённый]
- [критерий 2]

Контекст:
- Design doc: docs/[RELEVANT].md, секция [название]
- Существующие паттерны: [что нашли в кодбейсе]
- Зависимости: [пакеты/файлы от которых зависим]

Ограничения:
- [из PROJECT.md DO/DON'T]
- [из ответов оператора]
- [из критического анализа]

Примечания:
- [решения принятые на этапе анализа]
```

### 4.2 Запусти /feature

```
Используй Skill tool:
  skill: "feature"
  args: [составленный промпт]
```

---

## Обработка особых ситуаций

### Все фазы завершены
```
Если все ### заголовки содержат ✅:
"Все задачи в родмапе отмечены как завершённые!
Проверь docs/ROADMAP.md — возможно нужно обновить статусы."
```

### Зависимости не выполнены
```
Если найдены блокеры:
"Phase X.Y заблокирована: зависимость [Y.Z] не завершена.
Предлагаю сначала выполнить [Y.Z]. Запустить?"

Дай выбор через AskUserQuestion:
1. Выполнить блокирующую зависимость
2. Пропустить и взять следующую незаблокированную задачу
3. Игнорировать блокер (оператор решил)
```

### Слишком большая задача
```
Если задача содержит > 8 пунктов:
"Задача большая (N пунктов). Предлагаю разбить:
Часть 1: [задачи 1-3] — основа
Часть 2: [задачи 4-5] — расширение
Часть 3: [задачи 6-N] — тесты

Или делаем всё за один проход?"
```

---

## Старт

Начни с **ФАЗА 1: PARSE** — прочитай `docs/ROADMAP.md` и найди следующую задачу.
