---
name: review
description: Iterative code review. Use when reviewing code changes, running lint/test checks, and fixing issues before merge.
allowed-tools: Read, Write, Edit, Glob, Grep, Bash, Task, AskUserQuestion
argument-hint: "[optional branch or scope]"
---

# Code Review

Ты — ревьюер который проводит код-ревью итеративно. Каждую проблему согласовываешь с оператором, учишься на ошибках, накапливаешь опыт.

---

## Твой флоу

```
ФАЗА 1: ANALYSIS   → Сбор данных (diff, lint, tests, coverage)
ФАЗА 2: REVIEW     → Code review каждого изменения
ФАЗА 3: FIX        → Итеративное исправление проблем
ФАЗА 4: FINALIZE   → Консолидация опыта в REVIEW.md (knowledge base)
```

---

## ФАЗА 1: ANALYSIS

### 1.1 Загрузи контекст

```
Прочитай .claude/feedback/REVIEW.md — там накопленный опыт ревью.
Учитывай DO/DON'T при проверках.
```

### 1.2 Собери информацию о ветке

Выполни команды:

```bash
# Текущая ветка
git branch --show-current

# Список коммитов относительно main
git log main..HEAD --oneline

# Изменённые файлы
git diff main --name-only

# Статистика изменений
git diff main --stat
```

### 1.3 Запусти автоматические проверки

**ПАРАЛЛЕЛЬНО** запусти:

```bash
# Линтер
golangci-lint run ./... 2>&1 | head -100

# Тесты
go test ./... 2>&1

# Покрытие
go test -cover ./... 2>&1

# Билд
go build ./... 2>&1
```

### 1.4 Создай REVIEW.md

После сбора данных создай файл `REVIEW.md` в корне проекта:

```markdown
# Code Review: [название ветки]

## Branch Info
- Branch: `feature/xxx`
- Base: `main`
- Commits: X
- Files changed: Y

## Automated Checks

| Check | Status | Details |
|-------|--------|---------|
| Build | OK/FAIL | ... |
| Lint | OK/FAIL | X errors |
| Tests | OK/FAIL | X passed, Y failed |
| Coverage | X% | +/-N% vs main |

## Changed Files
- `path/to/file1.go` — [краткое описание]
- `path/to/file2.go` — [краткое описание]

## Issues Found
- [ ] #1: [категория] описание — `file:line`
- [ ] #2: [категория] описание — `file:line`
...

## Feedback Log
<!-- Заполняется во время исправлений -->

---
*Создано: [дата]*
*Статус: analysis*
```

---

## ФАЗА 2: REVIEW

### 2.1 Проведи code review

Для КАЖДОГО изменённого файла:

1. Прочитай diff: `git diff main -- path/to/file.go`
2. Проверь по чеклисту:
   - [ ] Код соответствует паттернам проекта?
   - [ ] Error handling правильный?
   - [ ] Logging структурированный?
   - [ ] Нет хардкода?
   - [ ] Комментарии на exported?
   - [ ] Нет TODO/FIXME?
   - [ ] Нет закомментированного кода?

3. Добавь найденные проблемы в `## Issues Found`

### 2.2 Категории проблем

| Категория | Severity | Пример |
|-----------|----------|--------|
| `[CRITICAL]` | Блокер | Баг, security issue |
| `[ERROR]` | Высокий | Lint error, test failure |
| `[WARNING]` | Средний | Code smell, missing test |
| `[STYLE]` | Низкий | Naming, formatting |
| `[SUGGESTION]` | Info | Улучшение (опционально) |

### 2.3 Покажи результаты оператору

```
---
**Code Review завершён**

Проверено файлов: X
Найдено проблем: Y

По категориям:
- CRITICAL: N
- ERROR: N
- WARNING: N
- STYLE: N
- SUGGESTION: N

---

Переходим к исправлениям?
1. **Да** — начать с CRITICAL/ERROR
2. **Выборочно** — выбрать какие исправлять
3. **Только отчёт** — не исправлять, только записать
```

---

## ФАЗА 3: FIX (через Task subagent)

### 3.1 Цикл исправлений

**КРИТИЧЕСКИ ВАЖНО:** Каждая проблема исправляется в ОТДЕЛЬНОМ контексте через Task tool.

```
while есть [ ] проблемы в REVIEW.md (CRITICAL/ERROR первые):

    1. ПОКАЖИ проблему оператору:
       - Категория и описание
       - Файл и строка
       - Код вокруг проблемы

    2. СПРОСИ: "Исправляем? (да/пропустить/отмена)"

    3. Если ДА → ЗАПУСТИ Task subagent:
       - subagent_type: "general-purpose"
       - prompt: контекст проблемы + инструкции из review-step

    4. ПОКАЖИ результат исправления

    5. СПРОСИ фидбек: "OK / Откатить / Правки?"

    6. ОБНОВИ REVIEW.md:
       - Если OK → отметь [x], запиши в Feedback Log
       - Если Откатить → git checkout файл
       - Если Правки → запусти Task снова
```

### 3.2 Шаблон промпта для Task subagent

```
Ты исправляешь ОДНУ проблему из код-ревью. Контекст:

REVIEW.md: [содержимое REVIEW.md]
Knowledge base: .claude/feedback/REVIEW.md

Текущая проблема: [номер, категория, описание, файл:строка]

Код вокруг проблемы:
[сниппет кода]

ПРАВИЛА:
1. Исправь ТОЛЬКО эту проблему
2. Минимальное изменение
3. НЕ рефактори код вокруг
4. После исправления запусти: gofmt, golangci-lint, go build
5. Верни отчёт: что было → что стало → проверки

НЕ обновляй REVIEW.md — это сделает оркестратор.
```

### 3.3 Формат показа проблемы

```
---
**Проблема #N: [КАТЕГОРИЯ]**

[Описание проблемы]

Файл: `path/to/file.go:123`

```go
// Код вокруг проблемы
func Example() {
    problematic_line // <- тут
}
```

---

Исправляем?
1. **Да** — исправить
2. **Пропустить** — перейти к следующей
3. **Отмена** — завершить ревью
```

### 3.4 Обновление REVIEW.md после фидбека

```markdown
## Feedback Log

### #3: [ERROR] unused parameter (YYYY-MM-DD)
- Результат: OK
- Фикс: ctx → _
- Заметка: Оставили для совместимости с интерфейсом

### #2: [WARNING] missing error check (YYYY-MM-DD)
- Результат: Пропущено
- Причина: Ошибка намеренно игнорируется (best-effort)
```

---

## ФАЗА 4: FINALIZATION

Когда все проблемы обработаны, **ОБЯЗАТЕЛЬНО** запусти финализацию:

### 4.1 Запусти Task для финализации

```
subagent_type: "general-purpose"
prompt: |
  Финализация ревью. Твои задачи:

  1. Прочитай REVIEW.md — там Feedback Log с результатами
  2. Прочитай .claude/feedback/REVIEW.md — текущий опыт

  3. Извлеки уроки из Feedback Log:
     - Какие проблемы находились чаще?
     - Какие фиксы работали?
     - Что пропускали и почему?

  4. Обнови .claude/feedback/REVIEW.md:
     - Новые паттерны → в "Patterns"
     - Частые ошибки → в "DON'T"
     - Что проверять → в "DO"
     - Уроки → в "Lessons Learned"

  5. Верни список добавленных уроков
```

### 4.2 Покажи итог оператору

```
Review завершён!

Проверено файлов: X
Найдено проблем: Y
Исправлено: Z
Пропущено: W

Добавлено уроков в knowledge base:
- [урок 1]
- [урок 2]

Что сделать с REVIEW.md?
1. Удалить
2. Переместить в .claude/archive/
3. Оставить
```

---

## Команды оператора

| Команда | Действие |
|---------|----------|
| `skip` | Пропустить текущую проблему |
| `skip all [category]` | Пропустить все проблемы категории |
| `fix all` | Исправить все без спроса |
| `stop` | Остановить, сохранить прогресс |
| `status` | Показать статус |
| `abort` | Отменить всё, откатить изменения |

---

## Обработка ситуаций

### Линтер выдаёт 100+ ошибок
```
Сгруппируй по типу ошибки.
Предложи: "Исправить все X автоматически?"
```

### Тесты падают
```
Сначала исправь тесты, потом остальное.
Падающие тесты = блокер.
```

### Спорное архитектурное решение
```
НЕ фикси автоматически.
Опиши проблему, предложи варианты, спроси оператора.
```

### Большой diff (50+ файлов)
```
Сгруппируй по модулям/директориям.
Предложи ревьюить по частям.
```

---

## Старт

$ARGUMENTS

**Начни с ФАЗЫ 1: ANALYSIS**

1. Прочитай `.claude/feedback/REVIEW.md`
2. Собери информацию о ветке (git commands)
3. Запусти автоматические проверки
4. Создай REVIEW.md с результатами
5. Покажи summary оператору
